<!DOCTYPE html>
<html>
    <head>
        
    </head>
    <body>
        <script src="http://ifx.path.uab.edu/ming/client.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.1.6/d3.min.js" charset="utf-8"></script>
        <script>
            var collection, database, endpoint, password, username;

            endpoint = "http://ifx.path.uab.edu/ming/server";
            username = "test";
            password = "Test123";
            database = ming({endpoint: endpoint, username: username, password: password});

            function getPatientFileList (callback) {
                var xhr;

                xhr = new XMLHttpRequest();

                xhr.open("POST", "http://agalpha.mathbiol.org/repositories/tcga?query=select%20%3FdiseaseStudy%20%3Fdate%20%3Furl%20%7B%0A%20%20%3Ffile%20tcga%3Aurl%20%3Furl%20.%0A%20%20%0A%20%20%3Ffile%20tcga%3AdiseaseStudy%20%3Fd%20.%0A%20%20%3Fd%20rdfs%3Alabel%20%3FdiseaseStudy%20.%0A%20%20%0A%20%20%3Ffile%20tcga%3Aplatform%20%3Fp%20.%0A%20%20%3Fp%20rdfs%3Alabel%20%22clin%22%20.%0A%20%20%0A%20%20%3Ffile%20tcga%3AlastSeen%20%3Fdate%20.%0A%20%20filter(%3Fdate%20%3E%20%222013-06%22)%20.%0A%20%20%0A%20%20%3Ffile%20rdfs%3Alabel%20%3Fname%20.%0A%20%20filter(contains(%3Fname%2C%20%22patient%22))%20.%0A%7D&queryLn=SPARQL&limit=100&infer=false");
                xhr.onload = function () {
                    callback(JSON.parse(this.responseText), this);
                };
                xhr.setRequestHeader("Accept", "application/json");
                xhr.send(null);
            }

            function tsvToMongo (url, callback) {

                d3.tsv("http://webrw-sucks.herokuapp.com/?get="+url, function (docs) {
                    database.collection("tcgaPatients", function (err, patients) {
                        function saveOneDoc (err) {
                            var doc, today;
                            today = (new Date()).toISOString().slice(0,10);
                            if (err) {
                                console.log(err);
                                callback(err);
                            } else if (docs.length > 0) {
                                doc = docs.pop();
                                doc.provenance = {};
                                doc.provenance.source_url = url;
                                doc.provenance.date_retrieved = today;
                                patients.insert(doc, saveOneDoc);
                            } else {
                                callback(null);
                            }
                        };
                        saveOneDoc();
                    });
                });

            }

            function parseSparqlJSON(json) {
                return json.values.map(function (value) {
                    var row = {};
                    json.names.forEach( function (name, index) {
                        row[name] = value[index];
                    });
                    return row;
                });
            }

            getPatientFileList( function (files) {
                var rows = parseSparqlJSON(files);
                function saveOneFile(err) {
                    if (err) {
                        console.log(err);
                    } else if (rows.length > 0) {
                        tsvToMongo(rows.pop().url.slice(1,-1), saveOneFile);
                    } else {
                        console.log("Done");
                    }
                };
                saveOneFile();
            });


        </script>
    </body>
</html>
